<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .page { display: none; }
        .page.active { display: block; }
        .modal, .modal-backdrop {
            display: none;
            transition: opacity 0.3s ease;
        }
        .modal.active, .modal-backdrop.active {
            display: flex;
            opacity: 1;
        }
        .modal-backdrop.active {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        .modal.active {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        .nav-button.active {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
        }
        .nav-button {
            transition: all 0.2s ease-in-out;
        }
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Cabeçalho -->
    <header class="bg-white shadow-md sticky top-0 z-30">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center">
                    <img id="logo-img" src="https://i.imgur.com/b6s5rvB.png" alt="Logo Escola da Barra" class="h-14 w-14 mr-4">
                    <span class="text-xl sm:text-2xl font-bold text-gray-800">Escola da Barra</span>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <button id="home-button" class="p-2 rounded-full text-gray-600 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    </button>
                    <button id="back-button" class="p-2 rounded-full text-gray-600 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div id="app-container" class="bg-white rounded-xl shadow-lg p-6 sm:p-8 w-full">

            <!-- Página: Dashboard -->
            <div id="dashboard-page" class="page active">
                <div class="flex justify-center flex-wrap gap-4 mb-8">
                    <button data-target="alunos-dashboard" class="nav-button active px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-100">Alunos</button>
                    <button data-target="cursos-dashboard" class="nav-button px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-100">Cursos</button>
                    <button data-target="pedagogico-dashboard" class="nav-button px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-100">Pedagógico</button>
                </div>
                
                <div id="alunos-dashboard" class="dashboard-content active">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-blue-500 text-white rounded-xl p-6 shadow-md transform hover:scale-105 transition-transform cursor-pointer" id="card-alunos-matriculados">
                            <h3 class="text-lg">Alunos Matriculados</h3>
                            <p id="alunos-count" class="text-5xl font-extrabold mt-2">0</p>
                        </div>
                        <div class="bg-green-500 text-white rounded-xl p-6 shadow-md transform hover:scale-105 transition-transform cursor-pointer" id="card-novo-aluno">
                            <h3 class="text-lg">Novo Aluno</h3>
                            <p class="text-5xl font-extrabold mt-2">+</p>
                        </div>
                    </div>
                </div>

                <div id="cursos-dashboard" class="dashboard-content hidden">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div id="card-cursos-fundamental" class="bg-indigo-500 text-white rounded-xl p-6 shadow-md transform hover:scale-105 transition-transform cursor-pointer" data-course-name="Fundamental">
                            <h3 class="text-lg">Ensino Fundamental</h3>
                            <p class="text-2xl font-bold mt-2">6º ao 9º ano</p>
                        </div>
                        <div id="card-cursos-medio" class="bg-purple-500 text-white rounded-xl p-6 shadow-md transform hover:scale-105 transition-transform cursor-pointer" data-course-name="Médio">
                            <h3 class="text-lg">Ensino Médio</h3>
                            <p class="text-2xl font-bold mt-2">1º ao 3º ano</p>
                        </div>
                    </div>
                </div>

                <div id="pedagogico-dashboard" class="dashboard-content hidden">
                    <div class="grid md:grid-cols-2 gap-6">
                         <div id="card-boletim" class="bg-teal-500 text-white rounded-xl p-6 shadow-md transform hover:scale-105 transition-transform cursor-pointer">
                            <h3 class="text-lg">Boletim Geral</h3>
                            <p class="text-2xl font-bold mt-2">Ver Notas</p>
                        </div>
                        <div id="card-download-boletim" class="bg-orange-500 text-white rounded-xl p-6 shadow-md transform hover:scale-105 transition-transform cursor-pointer">
                            <h3 class="text-lg">Download</h3>
                            <p class="text-2xl font-bold mt-2">Gerar Relatório</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Página: Cadastro de Aluno -->
            <div id="cadastro-page" class="page">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Cadastro de Aluno</h1>
                <form id="cadastro-form" class="space-y-4 max-w-lg mx-auto">
                    <input type="text" id="nome" placeholder="Nome Completo" required class="form-input">
                    <input type="text" id="rg" placeholder="RG" required class="form-input">
                    <input type="text" id="cpf" placeholder="CPF" required class="form-input">
                    <input type="email" id="email" placeholder="E-mail" required class="form-input">
                    <input type="tel" id="telefone" placeholder="Telefone" required class="form-input">
                    <input type="text" onfocus="(this.type='date')" onblur="(this.type='text')" id="dataNascimento" placeholder="Data de Nascimento" required class="form-input">
                    <input type="text" id="localNascimento" placeholder="Local de Nascimento" required class="form-input">
                    <input type="text" id="endereco" placeholder="Endereço Completo" required class="form-input">
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition-colors shadow-sm">Cadastrar Aluno</button>
                    <button type="button" id="prefill-button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-md transition-colors shadow-sm mt-2">Pré-preencher com dados de exemplo</button>
                </form>
            </div>
            
            <!-- Página: Lista de Alunos -->
            <div id="alunos-list-page" class="page"></div>

            <!-- Página: Detalhes do Aluno -->
            <div id="student-details-page" class="page"></div>

            <!-- Página: Anos de um Curso -->
            <div id="course-years-page" class="page"></div>

            <!-- Página: Disciplinas de um Ano -->
            <div id="year-subjects-page" class="page"></div>
            
            <!-- Página: Alunos por Disciplina/Notas -->
            <div id="subject-students-page" class="page"></div>

            <!-- Página: Boletim Geral -->
            <div id="boletim-geral-page" class="page"></div>

        </div>
    </main>
    
    <!-- Modal para adicionar aluno à disciplina -->
    <div id="add-student-to-subject-modal" class="modal fixed inset-0 items-center justify-center z-50"></div>
    <div id="add-student-to-subject-backdrop" class="modal-backdrop"></div>
    
    <!-- Modal para editar notas -->
    <div id="edit-grades-modal" class="modal fixed inset-0 items-center justify-center z-50"></div>
    <div id="edit-grades-backdrop" class="modal-backdrop"></div>
    
    <!-- Modal de edição de curso -->
    <div id="edit-course-modal" class="modal fixed inset-0 items-center justify-center z-50"></div>
    <div id="edit-course-backdrop" class="modal-backdrop"></div>

    <!-- Modal para download de boletins -->
    <div id="download-selection-modal" class="modal fixed inset-0 items-center justify-center z-50"></div>
    <div id="download-selection-backdrop" class="modal-backdrop"></div>
    
    <!-- Modal para criar novo curso -->
    <div id="create-course-modal" class="modal fixed inset-0 items-center justify-center z-50"></div>
    <div id="create-course-backdrop" class="modal-backdrop"></div>

    <!-- Template para CSS de inputs -->
    <style>
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
    </style>

    <script>
        let historyStack = ['dashboard-page'];
        const logoImgSrc = 'https://i.imgur.com/b6s5rvB.png';

        let cursosDisponiveis = JSON.parse(localStorage.getItem('cursosDisponiveis')) || {
            'Fundamental': {
                description: 'Ensino Fundamental do 6º ao 9º ano.',
                anos: {
                    '6º ano': {
                        disciplinas: {
                            'Linguagens': [{ nome: 'Língua Portuguesa', cargaHoraria: 80 }, { nome: 'Arte', cargaHoraria: 40 }, { nome: 'Educação Física', cargaHoraria: 40 }],
                            'Matemática': [{ nome: 'Matemática', cargaHoraria: 80 }],
                            'Ciências da Natureza': [{ nome: 'Ciências', cargaHoraria: 60 }],
                            'Ciências Humanas': [{ nome: 'História', cargaHoraria: 60 }, { nome: 'Geografia', cargaHoraria: 60 }]
                        }
                    },
                    '7º ano': {
                        disciplinas: {
                            'Linguagens': [{ nome: 'Língua Portuguesa', cargaHoraria: 80 }, { nome: 'Arte', cargaHoraria: 40 }, { nome: 'Educação Física', cargaHoraria: 40 }],
                            'Matemática': [{ nome: 'Matemática', cargaHoraria: 80 }],
                            'Ciências da Natureza': [{ nome: 'Ciências', cargaHoraria: 60 }],
                            'Ciências Humanas': [{ nome: 'História', cargaHoraria: 60 }, { nome: 'Geografia', cargaHoraria: 60 }]
                        }
                    },
                    '8º ano': {
                        disciplinas: {
                            'Linguagens': [{ nome: 'Língua Portuguesa', cargaHoraria: 80 }, { nome: 'Arte', cargaHoraria: 40 }, { nome: 'Educação Física', cargaHoraria: 40 }, { nome: 'Língua Inglesa', cargaHoraria: 40 }],
                            'Matemática': [{ nome: 'Matemática', cargaHoraria: 80 }],
                            'Ciências da Natureza': [{ nome: 'Ciências', cargaHoraria: 60 }],
                            'Ciências Humanas': [{ nome: 'História', cargaHoraria: 60 }, { nome: 'Geografia', cargaHoraria: 60 }]
                        }
                    },
                    '9º ano': {
                        disciplinas: {
                            'Linguagens': [{ nome: 'Língua Portuguesa', cargaHoraria: 80 }, { nome: 'Arte', cargaHoraria: 40 }, { nome: 'Educação Física', cargaHoraria: 40 }, { nome: 'Língua Inglesa', cargaHoraria: 40 }],
                            'Matemática': [{ nome: 'Matemática', cargaHoraria: 80 }],
                            'Ciências da Natureza': [{ nome: 'Ciências', cargaHoraria: 60 }],
                            'Ciências Humanas': [{ nome: 'História', cargaHoraria: 60 }, { nome: 'Geografia', cargaHoraria: 60 }]
                        }
                    }
                }
            },
            'Médio': {
                description: 'Ensino Médio do 1º ao 3º ano.',
                anos: {
                    '1º ano': {
                        disciplinas: {
                            'Linguagens': [{ nome: 'Língua Portuguesa', cargaHoraria: 80 }, { nome: 'Literatura', cargaHoraria: 40 }, { nome: 'Arte', cargaHoraria: 40 }, { nome: 'Educação Física', cargaHoraria: 40 }, { nome: 'Língua Inglesa', cargaHoraria: 40 }],
                            'Matemática': [{ nome: 'Matemática', cargaHoraria: 80 }],
                            'Ciências da Natureza': [{ nome: 'Biologia', cargaHoraria: 60 }, { nome: 'Física', cargaHoraria: 60 }, { nome: 'Química', cargaHoraria: 60 }],
                            'Ciências Humanas': [{ nome: 'História', cargaHoraria: 60 }, { nome: 'Geografia', cargaHoraria: 60 }, { nome: 'Sociologia', cargaHoraria: 40 }, { nome: 'Filosofia', cargaHoraria: 40 }]
                        }
                    },
                    '2º ano': {
                        disciplinas: {
                            'Linguagens': [{ nome: 'Língua Portuguesa', cargaHoraria: 80 }, { nome: 'Literatura', cargaHoraria: 40 }, { nome: 'Arte', cargaHoraria: 40 }, { nome: 'Educação Física', cargaHoraria: 40 }, { nome: 'Língua Inglesa', cargaHoraria: 40 }],
                            'Matemática': [{ nome: 'Matemática', cargaHoraria: 80 }],
                            'Ciências da Natureza': [{ nome: 'Biologia', cargaHoraria: 60 }, { nome: 'Física', cargaHoraria: 60 }, { nome: 'Química', cargaHoraria: 60 }],
                            'Ciências Humanas': [{ nome: 'História', cargaHoraria: 60 }, { nome: 'Geografia', cargaHoraria: 60 }, { nome: 'Sociologia', cargaHoraria: 40 }, { nome: 'Filosofia', cargaHoraria: 40 }]
                        }
                    },
                    '3º ano': {
                        disciplinas: {
                            'Linguagens': [{ nome: 'Língua Portuguesa', cargaHoraria: 80 }, { nome: 'Literatura', cargaHoraria: 40 }, { nome: 'Arte', cargaHoraria: 40 }, { nome: 'Educação Física', cargaHoraria: 40 }, { nome: 'Língua Inglesa', cargaHoraria: 40 }],
                            'Matemática': [{ nome: 'Matemática', cargaHoraria: 80 }],
                            'Ciências da Natureza': [{ nome: 'Biologia', cargaHoraria: 60 }, { nome: 'Física', cargaHoraria: 60 }, { nome: 'Química', cargaHoraria: 60 }],
                            'Ciências Humanas': [{ nome: 'História', cargaHoraria: 60 }, { nome: 'Geografia', cargaHoraria: 60 }, { nome: 'Sociologia', cargaHoraria: 40 }, { nome: 'Filosofia', cargaHoraria: 40 }]
                        }
                    }
                }
            }
        };

        let alunos = JSON.parse(localStorage.getItem('alunos')) || [];
        let matriculaCounter = parseInt(localStorage.getItem('matriculaCounter')) || 1000;

        function saveData() {
            localStorage.setItem('alunos', JSON.stringify(alunos));
            localStorage.setItem('matriculaCounter', matriculaCounter.toString());
            localStorage.setItem('cursosDisponiveis', JSON.stringify(cursosDisponiveis));
            updateDashboard();
        }

        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (historyStack[historyStack.length - 1] !== pageId) {
                historyStack.push(pageId);
            }
        }
        
        document.getElementById('home-button').addEventListener('click', () => {
            historyStack = ['dashboard-page'];
            navigateTo('dashboard-page');
        });

        document.getElementById('back-button').addEventListener('click', () => {
            if (historyStack.length > 1) {
                historyStack.pop();
                const previousPage = historyStack[historyStack.length - 1];
                navigateTo(previousPage);
            }
        });
        
        function updateDashboard() {
            document.getElementById('alunos-count').textContent = alunos.length;
        }

        function renderAlunosList() {
            const container = document.getElementById('alunos-list-page');
            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Alunos Matriculados</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${alunos.map(aluno => `
                        <div class="bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow" data-aluno-id="${aluno.id}">
                            <div class="flex items-center">
                                <img src="https://i.pravatar.cc/150?u=${aluno.id}" alt="Foto do Aluno" class="w-16 h-16 rounded-full mr-4">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">${aluno.nome}</h3>
                                    <p class="text-sm text-gray-500">Matrícula: ${aluno.matricula}</p>
                                    <p class="text-sm text-gray-500">Cadastro: ${new Date(aluno.dataCadastro).toLocaleDateString()}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            navigateTo('alunos-list-page');
        }

        function renderStudentDetails(alunoId) {
            const aluno = alunos.find(a => a.id === alunoId);
            if (!aluno) return;

            const container = document.getElementById('student-details-page');
            container.innerHTML = `
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                    <div class="flex flex-col sm:flex-row items-center sm:items-start">
                        <img src="https://i.pravatar.cc/150?u=${aluno.id}" alt="Foto do Aluno" class="w-32 h-32 rounded-full mb-6 sm:mb-0 sm:mr-8 border-4 border-blue-200">
                        <div class="text-center sm:text-left flex-grow">
                            <h1 class="text-3xl font-bold text-gray-800">${aluno.nome}</h1>
                            <p class="text-gray-500">Matrícula: ${aluno.matricula}</p>
                            <p class="text-gray-500">Data de Matrícula: ${new Date(aluno.dataCadastro).toLocaleDateString()}</p>
                        </div>
                        <button id="edit-student-btn" class="mt-4 sm:mt-0 p-2 rounded-full hover:bg-gray-200" data-aluno-id="${aluno.id}">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                        </button>
                    </div>
                    <div class="mt-8 border-t pt-6 grid grid-cols-1 md:grid-cols-2 gap-6" id="student-info-container">
                        ${renderStudentInfo(aluno)}
                    </div>
                    <div class="mt-8 border-t pt-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Documentos</h2>
                        <div class="space-y-4">
                            ${['RG', 'CPF', 'COMP. Endereço', 'Certidão de Nascimento', 'Histórico Escolar Anterior'].map(doc => `
                                <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg">
                                    <span class="text-gray-700">${doc}</span>
                                    <label class="cursor-pointer bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-4 rounded-md transition-colors">
                                        Upload
                                        <input type="file" class="hidden" disabled>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            navigateTo('student-details-page');
        }
        
        function renderStudentInfo(aluno, isEditing = false) {
             if (isEditing) {
                return `
                    <div><strong class="text-gray-600">RG:</strong> ${aluno.rg}</div>
                    <div><strong class="text-gray-600">CPF:</strong> ${aluno.cpf}</div>
                    <div><strong class="text-gray-600">Data de Nasc.:</strong> ${aluno.dataNascimento}</div>
                    <div><strong class="text-gray-600">Local de Nasc.:</strong> ${aluno.localNascimento}</div>
                    <div><strong class="text-gray-600">E-mail:</strong> <input type="email" id="edit-email" value="${aluno.email}" class="form-input"></div>
                    <div><strong class="text-gray-600">Telefone:</strong> <input type="tel" id="edit-telefone" value="${aluno.telefone}" class="form-input"></div>
                    <div class="md:col-span-2"><strong class="text-gray-600">Endereço:</strong> <input type="text" id="edit-endereco" value="${aluno.endereco}" class="form-input"></div>
                    <div class="md:col-span-2 flex justify-end gap-2 mt-4">
                        <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-300 rounded-md">Cancelar</button>
                        <button id="save-edit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md">Salvar</button>
                    </div>
                `;
            } else {
                return `
                    <div><strong class="text-gray-600">RG:</strong> ${aluno.rg}</div>
                    <div><strong class="text-gray-600">CPF:</strong> ${aluno.cpf}</div>
                    <div><strong class="text-gray-600">Data de Nasc.:</strong> ${aluno.dataNascimento}</div>
                    <div><strong class="text-gray-600">Local de Nasc.:</strong> ${aluno.localNascimento}</div>
                    <div><strong class="text-gray-600">E-mail:</strong> ${aluno.email}</div>
                    <div><strong class="text-gray-600">Telefone:</strong> ${aluno.telefone}</div>
                    <div class="md:col-span-2"><strong class="text-gray-600">Endereço:</strong> ${aluno.endereco}</div>
                `;
            }
        }

        function renderCoursesPage() {
            const container = document.getElementById('cursos-dashboard');
            let content = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Cursos</h1>
                    <button id="create-course-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Novo Curso
                    </button>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${Object.keys(cursosDisponiveis).map(courseName => `
                        <div class="bg-white rounded-xl p-6 shadow-md transform hover:scale-105 transition-transform" data-course-name="${courseName}">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold text-gray-800">${courseName}</h3>
                            </div>
                            <div class="mt-4">
                                <p class="text-sm text-gray-500">${Object.keys(cursosDisponiveis[courseName].anos).join(', ')}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            container.innerHTML = content;
        }

        function renderCourseYears(courseName) {
            const course = cursosDisponiveis[courseName];
            if (!course) {
                console.error('Curso não encontrado:', courseName);
                navigateTo('dashboard-page');
                return;
            }
            const container = document.getElementById('course-years-page');
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Anos do Ensino ${courseName}</h1>
                    <button class="edit-course-btn p-1 rounded-full hover:bg-gray-200" data-course-name="${courseName}">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                    </button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    ${Object.keys(course.anos).map(ano => `
                        <div class="bg-white p-6 rounded-lg shadow-md cursor-pointer hover:bg-blue-50 text-center" data-course="${courseName}" data-year="${ano}">
                            <h3 class="font-bold text-xl text-blue-700">${ano}</h3>
                        </div>
                    `).join('')}
                </div>
            `;
            navigateTo('course-years-page');
        }

        function renderYearSubjects(courseName, year) {
            const course = cursosDisponiveis[courseName];
            const container = document.getElementById('year-subjects-page');
            const disciplinasDoAno = course.anos[year].disciplinas;
            let content = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">${year} - ${courseName}</h1>
                    <button class="edit-course-btn p-1 rounded-full hover:bg-gray-200" data-course-name="${courseName}">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                    </button>
                </div>`;

            for (const area in disciplinasDoAno) {
                content += `<h2 class="text-2xl font-semibold text-gray-700 mt-6 mb-3 border-b-2 pb-2">${area}</h2>`;
                content += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                content += disciplinasDoAno[area].map(disciplina => `
                    <div class="bg-gray-100 p-4 rounded-lg shadow-sm cursor-pointer hover:bg-gray-200" data-course="${courseName}" data-year="${year}" data-subject="${disciplina.nome}">
                        <p class="font-semibold text-gray-800">${disciplina.nome}</p>
                    </div>
                `).join('');
                content += '</div>';
            }
            container.innerHTML = content;
            navigateTo('year-subjects-page');
        }
        
        function renderSubjectStudents(courseName, year, subject) {
            const subjectKey = `${courseName}-${year}-${subject}`;
            const matriculados = alunos.filter(a => a.matriculas && a.matriculas[subjectKey]);
            
            const container = document.getElementById('subject-students-page');
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">${subject}</h1>
                        <p class="text-gray-500">${year} - ${courseName}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-semibold">Alunos Matriculados</p>
                        <p class="text-3xl font-bold text-blue-600">${matriculados.length}</p>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-6">
                    <button id="add-student-to-subject-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Adicionar Aluno
                    </button>
                    <button id="edit-subject-btn" class="p-2 rounded-full hover:bg-gray-200" data-course-name="${courseName}" data-year="${year}" data-subject="${subject}">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                    </button>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <ul class="divide-y divide-gray-200">
                        ${matriculados.length > 0 ? matriculados.map(aluno => `
                            <li class="py-3 flex justify-between items-center">
                                <div class="flex items-center">
                                    <img src="https://i.pravatar.cc/150?u=${aluno.id}" class="w-10 h-10 rounded-full mr-3">
                                    <div>
                                        <p class="font-semibold">${aluno.nome}</p>
                                        <p class="text-sm text-gray-500">Matrícula: ${aluno.matricula}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <button class="view-grades-btn p-2 rounded-full hover:bg-gray-200" data-aluno-id="${aluno.id}" data-subject-key="${subjectKey}">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                                    </button>
                                     <button class="edit-grades-btn p-2 rounded-full hover:bg-gray-200" data-aluno-id="${aluno.id}" data-subject-key="${subjectKey}">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                                    </button>
                                    <button class="download-individual-grades-btn p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200" data-aluno-id="${aluno.id}" data-subject-key="${subjectKey}">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    </button>
                                </div>
                            </li>
                        `).join('') : '<li class="py-3 text-center text-gray-500">Nenhum aluno matriculado nesta disciplina.</li>'}
                    </ul>
                </div>
            `;
            navigateTo('subject-students-page');
            document.getElementById('add-student-to-subject-btn').dataset.subjectKey = subjectKey;
        }
        
        function renderBoletimGeral() {
            const container = document.getElementById('boletim-geral-page');
            let content = `<h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Boletim Geral de Notas</h1>`;

            alunos.forEach(aluno => {
                if (aluno.matriculas && Object.keys(aluno.matriculas).length > 0) {
                    content += `
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h2 class="text-xl font-bold">${aluno.nome}</h2>
                                    <p class="text-gray-600">Matrícula: ${aluno.matricula}</p>
                                </div>
                                <button class="download-individual-boletim-btn p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200" data-aluno-id="${aluno.id}">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                </button>
                            </div>
                            <div class="overflow-x-auto mt-4">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Curso / Série</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Disciplina</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Média Final</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${Object.entries(aluno.matriculas).map(([key, data]) => {
                                            const [curso, ano, disciplina] = key.split('-');
                                            const media = calcularMediaFinal(data.notas).toFixed(1);
                                            return `
                                                <tr>
                                                    <td class="px-6 py-4 whitespace-nowrap">${curso} - ${ano}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap">${disciplina}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-center font-bold ${media >= 7 ? 'text-green-600' : 'text-red-600'}">${media.replace('.', ',')}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            });
             if (!content.includes('<div class="bg-white')) {
                content += '<p class="text-center text-gray-500">Nenhum aluno com notas para exibir.</p>';
            }
            container.innerHTML = content;
            navigateTo('boletim-geral-page');
        }

        function openAddStudentToSubjectModal(subjectKey) {
            const modal = document.getElementById('add-student-to-subject-modal');
            const backdrop = document.getElementById('add-student-to-subject-backdrop');
            
            const matriculadosIds = alunos
                .filter(a => a.matriculas && a.matriculas[subjectKey])
                .map(a => a.id);
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                    <h2 class="text-xl font-bold mb-4">Adicionar Aluno à Disciplina</h2>
                    <ul class="max-h-80 overflow-y-auto divide-y divide-gray-200">
                        ${alunos.map(aluno => `
                            <li class="py-2 flex items-center justify-between">
                                <span>${aluno.nome}</span>
                                <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600" data-aluno-id="${aluno.id}" ${matriculadosIds.includes(aluno.id) ? 'checked' : ''}>
                            </li>
                        `).join('')}
                    </ul>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancel-add-student" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button id="confirm-add-student" class="px-4 py-2 bg-blue-600 text-white rounded-md">Salvar</button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
            backdrop.classList.add('active');

            backdrop.onclick = () => closeAddStudentToSubjectModal(subjectKey);
            document.getElementById('cancel-add-student').onclick = () => closeAddStudentToSubjectModal(subjectKey);
            document.getElementById('confirm-add-student').onclick = () => {
                const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    const alunoId = cb.dataset.alunoId;
                    const aluno = alunos.find(a => a.id === alunoId);
                    
                    if (cb.checked) {
                         if (!aluno.matriculas) aluno.matriculas = {};
                        if (!aluno.matriculas[subjectKey]) {
                            aluno.matriculas[subjectKey] = {
                                notas: { atv1: 0, rec1: 0, atv2: 0, rec2: 0, final: 0, recFinal: 0 }
                            };
                        }
                    } else {
                        if (aluno.matriculas && aluno.matriculas[subjectKey]) {
                            delete aluno.matriculas[subjectKey];
                        }
                    }
                });
                saveData();
                const [courseName, year, subject] = subjectKey.split('-');
                renderSubjectStudents(courseName, year, subject);
                closeAddStudentToSubjectModal(subjectKey);
            };
        }

        function closeAddStudentToSubjectModal() {
            document.getElementById('add-student-to-subject-modal').classList.remove('active');
            document.getElementById('add-student-to-subject-backdrop').classList.remove('active');
        }
        
        function openEditGradesModal(alunoId, subjectKey) {
            const aluno = alunos.find(a => a.id === alunoId);
            const notas = aluno.matriculas[subjectKey].notas;
            const modal = document.getElementById('edit-grades-modal');
            const backdrop = document.getElementById('edit-grades-backdrop');

            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
                    <h2 class="text-xl font-bold mb-4">Editar Notas de ${aluno.nome}</h2>
                    <div class="grid grid-cols-2 gap-4">
                        ${Object.keys(notas).map(key => `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 uppercase">${key}</label>
                                <input type="number" id="grade-${key}" value="${notas[key]}" class="form-input mt-1" min="0" max="10" step="0.1">
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancel-edit-grades" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button id="save-edit-grades" class="px-4 py-2 bg-blue-600 text-white rounded-md">Salvar</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            backdrop.classList.add('active');

            backdrop.onclick = closeEditGradesModal;
            document.getElementById('cancel-edit-grades').onclick = closeEditGradesModal;
            document.getElementById('save-edit-grades').onclick = () => {
                Object.keys(notas).forEach(key => {
                    notas[key] = parseFloat(document.getElementById(`grade-${key}`).value) || 0;
                });
                saveData();
                closeEditGradesModal();
            };
        }

        function closeEditGradesModal() {
            document.getElementById('edit-grades-modal').classList.remove('active');
            document.getElementById('edit-grades-backdrop').classList.remove('active');
        }
        
        function openDownloadSelectionModal() {
            const modal = document.getElementById('download-selection-modal');
            const backdrop = document.getElementById('download-selection-backdrop');
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                    <h2 class="text-xl font-bold mb-4">Selecionar Alunos para Download</h2>
                    <div class="mb-4">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="select-all-students-download" class="form-checkbox h-5 w-5">
                            <span class="ml-2">Selecionar Todos</span>
                        </label>
                    </div>
                    <ul id="student-download-list" class="max-h-80 overflow-y-auto divide-y divide-gray-200 border rounded-md p-2">
                        ${alunos.map(aluno => `
                            <li class="py-2">
                                <label class="inline-flex items-center w-full">
                                    <input type="checkbox" class="form-checkbox h-5 w-5 student-download-checkbox" value="${aluno.id}">
                                    <span class="ml-3">${aluno.nome}</span>
                                </label>
                            </li>
                        `).join('')}
                    </ul>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancel-download" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button id="confirm-download" class="px-4 py-2 bg-blue-600 text-white rounded-md">Gerar PDF</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            backdrop.classList.add('active');
            
            backdrop.onclick = closeDownloadSelectionModal;
            document.getElementById('cancel-download').onclick = closeDownloadSelectionModal;
            
            const selectAllCheckbox = document.getElementById('select-all-students-download');
            const studentCheckboxes = document.querySelectorAll('.student-download-checkbox');
            selectAllCheckbox.onchange = (e) => {
                studentCheckboxes.forEach(cb => cb.checked = e.target.checked);
            };

            document.getElementById('confirm-download').onclick = () => {
                const selectedIds = Array.from(studentCheckboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                if (selectedIds.length > 0) {
                    const selectedAlunos = alunos.filter(a => selectedIds.includes(a.id));
                    generatePDF(selectedAlunos, 'Boletim_Geral');
                }
                closeDownloadSelectionModal();
            };
        }

        function closeDownloadSelectionModal() {
            document.getElementById('download-selection-modal').classList.remove('active');
            document.getElementById('download-selection-backdrop').classList.remove('active');
        }

        function openEditCourseModal(courseName) {
            const course = cursosDisponiveis[courseName];
             if (!course) return;
            const modal = document.getElementById('edit-course-modal');
            const backdrop = document.getElementById('edit-course-backdrop');
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
                    <h2 class="text-xl font-bold mb-4">Editar Curso: ${courseName}</h2>
                    <div class="mb-4">
                        <h3 class="font-bold mb-2">Anos</h3>
                        <div id="edit-years" class="flex flex-wrap gap-2 mb-4">
                            ${Object.keys(course.anos).map(ano => `<span class="px-3 py-1 bg-gray-200 rounded-full">${ano}</span>`).join('')}
                        </div>
                    </div>
                    <div id="disciplinas-editor" class="space-y-4">
                        <h3 class="font-bold mb-2">Disciplinas por Área</h3>
                        ${Object.keys(course.anos).map(ano => `
                            <div class="bg-gray-100 p-4 rounded-md">
                                <h4 class="font-semibold text-lg mb-2">${ano}</h4>
                                <div class="space-y-2">
                                    ${Object.keys(course.anos[ano].disciplinas).map(area => `
                                        <div class="bg-white p-3 rounded-md shadow-sm">
                                            <div class="flex justify-between items-center mb-1">
                                                <h5 class="font-bold">${area}</h5>
                                                <button class="remove-area-btn text-red-500 hover:text-red-700" data-course-name="${courseName}" data-year-name="${ano}" data-area-name="${area}">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-1 12H5L4 7m5 0V4a1 1 0 011-1h4a1 1 0 011 1v3M9 7h6"></path></svg>
                                                </button>
                                            </div>
                                            <div class="flex flex-wrap gap-2 mt-2">
                                                ${course.anos[ano].disciplinas[area].map(disciplina => `
                                                    <div class="flex items-center px-3 py-1 bg-gray-200 rounded-full text-sm">
                                                        <span>${disciplina.nome}</span>
                                                        <button class="remove-disciplina-btn ml-2 text-red-400 hover:text-red-600" data-course-name="${courseName}" data-year-name="${ano}" data-area-name="${area}" data-disciplina-name="${disciplina.nome}">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                    <div class="flex gap-2 mt-4">
                                        <input type="text" class="add-area-input form-input" data-course-name="${courseName}" data-year-name="${ano}" placeholder="Nova área...">
                                        <button class="add-area-btn bg-gray-400 text-white rounded-md px-3 py-1">Add</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancel-edit-course" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button id="save-edit-course" class="px-4 py-2 bg-blue-600 text-white rounded-md">Salvar Mudanças</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            backdrop.classList.add('active');

            backdrop.onclick = closeEditCourseModal;
            document.getElementById('cancel-edit-course').onclick = closeEditCourseModal;
            
            document.getElementById('save-edit-course').onclick = () => {
                saveData();
                closeEditCourseModal();
            };

            modal.addEventListener('click', (e) => {
                const removeAreaBtn = e.target.closest('.remove-area-btn');
                if (removeAreaBtn) {
                    const { courseName, yearName, areaName } = removeAreaBtn.dataset;
                    delete cursosDisponiveis[courseName].anos[yearName].disciplinas[areaName];
                    saveData();
                    openEditCourseModal(courseName);
                    return;
                }

                const removeDisciplinaBtn = e.target.closest('.remove-disciplina-btn');
                if (removeDisciplinaBtn) {
                    const { courseName, yearName, areaName, disciplinaName } = removeDisciplinaBtn.dataset;
                    let disciplinas = cursosDisponiveis[courseName].anos[yearName].disciplinas[areaName];
                    disciplinas = disciplinas.filter(d => d.nome !== disciplinaName);
                    cursosDisponiveis[courseName].anos[yearName].disciplinas[areaName] = disciplinas;
                    saveData();
                    openEditCourseModal(courseName);
                    return;
                }

                const addAreaBtn = e.target.closest('.add-area-btn');
                if (addAreaBtn) {
                    const { courseName, yearName } = addAreaBtn.dataset;
                    const input = addAreaBtn.previousElementSibling;
                    const newAreaName = input.value.trim();
                    if (newAreaName) {
                        cursosDisponiveis[courseName].anos[yearName].disciplinas[newAreaName] = [];
                        saveData();
                        openEditCourseModal(courseName);
                    }
                }
            });
        }

        function closeEditCourseModal() {
            document.getElementById('edit-course-modal').classList.remove('active');
            document.getElementById('edit-course-backdrop').classList.remove('active');
        }

        function openCreateCourseModal() {
            const modal = document.getElementById('create-course-modal');
            const backdrop = document.getElementById('create-course-backdrop');
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
                    <h2 class="text-xl font-bold mb-4">Criar Novo Curso</h2>
                    <input type="text" id="new-course-name" class="form-input mb-4" placeholder="Nome do Curso (ex: Pós-Graduação)">
                    <input type="text" id="new-course-description" class="form-input mb-4" placeholder="Descrição do Curso">
                    <div id="new-course-content-container" class="space-y-4 max-h-80 overflow-y-auto">
                        <div class="course-year-editor border p-4 rounded-md bg-gray-100">
                            <h3 class="font-bold text-lg mb-2">Ano</h3>
                            <input type="text" class="course-year-name form-input mb-2" placeholder="Ex: 1º Ano">
                            <div class="disciplines-container space-y-2">
                                <div class="discipline-area-editor p-2 rounded-md bg-white">
                                    <div class="flex items-center gap-2 mb-2">
                                        <input type="text" class="discipline-area-name form-input" placeholder="Área (ex: Linguagens)">
                                        <button class="add-discipline-btn p-2 text-gray-500 hover:text-blue-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                        </button>
                                    </div>
                                    <div class="discipline-inputs space-y-1 ml-4">
                                        <div class="flex gap-2 items-center">
                                            <input type="text" class="discipline-name-input form-input" placeholder="Nome da Disciplina">
                                            <input type="number" class="discipline-hours-input form-input w-20" placeholder="CH">
                                            <button class="remove-discipline-btn p-1 text-red-500 hover:text-red-700">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <button class="add-area-btn mt-2 w-full bg-gray-200 hover:bg-gray-300 rounded-md py-1 text-sm">Adicionar Área</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="add-new-year-btn" class="mt-2 w-full bg-gray-300 hover:bg-gray-400 rounded-md py-2 text-sm">Adicionar Ano</button>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancel-create-course" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button id="confirm-create-course" class="px-4 py-2 bg-blue-600 text-white rounded-md">Criar Curso</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            backdrop.classList.add('active');

            backdrop.onclick = closeCreateCourseModal;
            document.getElementById('cancel-create-course').onclick = closeCreateCourseModal;

            const newCourseContainer = document.getElementById('new-course-content-container');
            
            document.getElementById('add-new-year-btn').onclick = () => {
                 const yearEditor = document.querySelector('.course-year-editor').cloneNode(true);
                 yearEditor.querySelector('.course-year-name').value = '';
                 yearEditor.querySelectorAll('.discipline-area-editor').forEach(area => area.remove());
                 newCourseContainer.appendChild(yearEditor);
            };

            document.getElementById('confirm-create-course').onclick = () => {
                const newCourseName = document.getElementById('new-course-name').value.trim();
                const newCourseDesc = document.getElementById('new-course-description').value.trim();
                
                if (!newCourseName) { alert('Nome do curso é obrigatório.'); return; }

                const anos = {};
                document.querySelectorAll('.course-year-editor').forEach(yearEditor => {
                    const anoName = yearEditor.querySelector('.course-year-name').value.trim();
                    if (!anoName) return;

                    const disciplinas = {};
                    yearEditor.querySelectorAll('.discipline-area-editor').forEach(areaEditor => {
                        const areaName = areaEditor.querySelector('.discipline-area-name').value.trim();
                        if (!areaName) return;

                        const areaDisciplinas = [];
                        areaEditor.querySelectorAll('.discipline-inputs > div').forEach(disciplineInput => {
                            const nome = disciplineInput.querySelector('.discipline-name-input').value.trim();
                            const cargaHoraria = parseInt(disciplineInput.querySelector('.discipline-hours-input').value) || 0;
                            if (nome) areaDisciplinas.push({ nome, cargaHoraria });
                        });
                        disciplinas[areaName] = areaDisciplinas;
                    });
                    anos[anoName] = { disciplinas };
                });
                
                if (Object.keys(anos).length === 0) {
                    alert('Adicione pelo menos um ano ao curso.');
                    return;
                }

                cursosDisponiveis[newCourseName] = { description: newCourseDesc, anos };
                saveData();
                renderCoursesPage();
                closeCreateCourseModal();
            };

            modal.addEventListener('click', (e) => {
                if (e.target.closest('.add-area-btn')) {
                    const disciplinesContainer = e.target.closest('.discipline-area-editor').parentNode;
                    const newAreaEditor = document.querySelector('.discipline-area-editor').cloneNode(true);
                    newAreaEditor.querySelector('.discipline-area-name').value = '';
                    newAreaEditor.querySelector('.discipline-inputs').innerHTML = `
                        <div class="flex gap-2 items-center">
                            <input type="text" class="discipline-name-input form-input" placeholder="Nome da Disciplina">
                            <input type="number" class="discipline-hours-input form-input w-20" placeholder="CH">
                            <button class="remove-discipline-btn p-1 text-red-500 hover:text-red-700">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>
                    `;
                    disciplinesContainer.appendChild(newAreaEditor);
                } else if (e.target.closest('.add-discipline-btn')) {
                    const disciplineInputsContainer = e.target.closest('.discipline-area-editor').querySelector('.discipline-inputs');
                    const newDisciplineInput = document.createElement('div');
                    newDisciplineInput.className = 'flex gap-2 items-center';
                    newDisciplineInput.innerHTML = `
                        <input type="text" class="discipline-name-input form-input" placeholder="Nome da Disciplina">
                        <input type="number" class="discipline-hours-input form-input w-20" placeholder="CH">
                        <button class="remove-discipline-btn p-1 text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    `;
                    disciplineInputsContainer.appendChild(newDisciplineInput);
                } else if (e.target.closest('.remove-discipline-btn')) {
                    e.target.closest('.flex.gap-2.items-center').remove();
                }
            });
        }

        function closeCreateCourseModal() {
            document.getElementById('create-course-modal').classList.remove('active');
            document.getElementById('create-course-backdrop').classList.remove('active');
        }

        function calcularMediaFinal(notas) {
            const nota1 = Math.max(notas.atv1, notas.rec1);
            const nota2 = Math.max(notas.atv2, notas.rec2);
            const notaFinal = Math.max(notas.final, notas.recFinal);
            return (nota1 + nota2 + notaFinal) / 3;
        }
        
        function generatePDF(alunosParaPDF, filename) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const logo = new Image();
            logo.src = logoImgSrc;
            logo.onload = function() {
                const logoData = this.src;
                
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text('Boletim Escolar', 105, 25, { align: 'center' });
                doc.addImage(logoData, 'PNG', 15, 15, 20, 20);

                let startY = 40;

                alunosParaPDF.forEach((aluno, index) => {
                    const alunoMatriculas = Object.values(aluno.matriculas);
                    
                    if (index > 0 && startY > 250) {
                        doc.addPage();
                        startY = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${aluno.nome}`, 15, startY);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Matrícula: ${aluno.matricula}`, 15, startY + 5);
                    
                    const head = [['Curso', 'Série', 'Disciplina', 'Média Final']];
                    const body = Object.entries(aluno.matriculas).map(([key, data]) => {
                        const [curso, ano, disciplina] = key.split('-');
                        const media = calcularMediaFinal(data.notas).toFixed(1);
                        return [curso, ano, disciplina, media];
                    });
                    
                    doc.autoTable({
                        startY: startY + 10,
                        head: head,
                        body: body,
                        theme: 'striped',
                        headStyles: { fillColor: [41, 128, 185], textColor: 255 },
                        didDrawPage: function(data) {
                            startY = data.cursor.y + 15;
                        }
                    });
                     startY = doc.lastAutoTable.finalY + 15;
                });

                doc.save(`${filename}.pdf`);
            };
            logo.onerror = function() {
                console.error("Erro ao carregar a imagem do logo.");
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateDashboard();
        });

        document.getElementById('cadastro-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const novoAluno = {
                id: crypto.randomUUID(),
                matricula: `MAT-${++matriculaCounter}`,
                nome: document.getElementById('nome').value,
                rg: document.getElementById('rg').value,
                cpf: document.getElementById('cpf').value,
                email: document.getElementById('email').value,
                telefone: document.getElementById('telefone').value,
                dataNascimento: document.getElementById('dataNascimento').value,
                localNascimento: document.getElementById('localNascimento').value,
                endereco: document.getElementById('endereco').value,
                dataCadastro: new Date().toISOString(),
                matriculas: {},
            };
            alunos.push(novoAluno);
            saveData();
            e.target.reset();
            renderAlunosList();
        });

        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                document.querySelectorAll('.dashboard-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(button.dataset.target).classList.remove('hidden');
                
                if (button.dataset.target === 'cursos-dashboard') {
                    renderCoursesPage();
                }
            });
        });
        
        document.getElementById('card-alunos-matriculados').addEventListener('click', renderAlunosList);
        document.getElementById('card-novo-aluno').addEventListener('click', () => navigateTo('cadastro-page'));
        document.getElementById('card-cursos-fundamental').addEventListener('click', () => renderCourseYears('Fundamental'));
        document.getElementById('card-cursos-medio').addEventListener('click', () => renderCourseYears('Médio'));
        document.getElementById('card-boletim').addEventListener('click', renderBoletimGeral);
        document.getElementById('card-download-boletim').addEventListener('click', openDownloadSelectionModal);
        
        document.addEventListener('click', (e) => {
            const studentCard = e.target.closest('[data-aluno-id]');
            if (studentCard && document.getElementById('alunos-list-page').contains(studentCard)) {
                renderStudentDetails(studentCard.dataset.alunoId);
            }
            
            const editBtn = e.target.closest('#edit-student-btn');
            if(editBtn) {
                 const alunoId = editBtn.dataset.alunoId;
                 const aluno = alunos.find(a => a.id === alunoId);
                 document.getElementById('student-info-container').innerHTML = renderStudentInfo(aluno, true);
            }

            const cancelBtn = e.target.closest('#cancel-edit-btn');
            if(cancelBtn) {
                 const alunoId = document.getElementById('edit-student-btn').dataset.alunoId;
                 const aluno = alunos.find(a => a.id === alunoId);
                 document.getElementById('student-info-container').innerHTML = renderStudentInfo(aluno, false);
            }

            const saveBtn = e.target.closest('#save-edit-btn');
            if(saveBtn) {
                 const alunoId = document.getElementById('edit-student-btn').dataset.alunoId;
                 const aluno = alunos.find(a => a.id === alunoId);
                 aluno.email = document.getElementById('edit-email').value;
                 aluno.telefone = document.getElementById('edit-telefone').value;
                 aluno.endereco = document.getElementById('edit-endereco').value;
                 saveData();
                 document.getElementById('student-info-container').innerHTML = renderStudentInfo(aluno, false);
            }

            const courseCard = e.target.closest('[data-course-name]');
            if (courseCard && document.getElementById('cursos-dashboard').contains(courseCard)) {
                renderCourseYears(courseCard.dataset.courseName);
            }

            const courseYearCard = e.target.closest('[data-course][data-year]');
             if (courseYearCard && document.getElementById('course-years-page').contains(courseYearCard)) {
                renderYearSubjects(courseYearCard.dataset.course, courseYearCard.dataset.year);
            }
            
            const yearSubjectCard = e.target.closest('[data-course][data-year][data-subject]');
            if (yearSubjectCard && document.getElementById('year-subjects-page').contains(yearSubjectCard)) {
                renderSubjectStudents(yearSubjectCard.dataset.course, yearSubjectCard.dataset.year, yearSubjectCard.dataset.subject);
            }

            const addStudentBtn = e.target.closest('#add-student-to-subject-btn');
            if (addStudentBtn) {
                openAddStudentToSubjectModal(addStudentBtn.dataset.subjectKey);
            }

            const editGradesBtn = e.target.closest('.edit-grades-btn');
            if (editGradesBtn) {
                openEditGradesModal(editGradesBtn.dataset.alunoId, editGradesBtn.dataset.subjectKey);
            }
            
            const individualDownloadBtn = e.target.closest('.download-individual-boletim-btn');
            if (individualDownloadBtn) {
                const alunoId = individualDownloadBtn.dataset.alunoId;
                const aluno = alunos.find(a => a.id === alunoId);
                generatePDF([aluno], `Boletim_${aluno.nome.replace(/\s+/g, '_')}`);
            }
            
            const editCourseBtn = e.target.closest('.edit-course-btn');
            if (editCourseBtn) {
                openEditCourseModal(editCourseBtn.dataset.courseName);
            }

            const createCourseBtn = e.target.closest('#create-course-btn');
            if (createCourseBtn) {
                openCreateCourseModal();
            }
        });

        document.getElementById('prefill-button').addEventListener('click', () => {
             const exampleStudents = [
                { nome: 'Luiz', rg: '64654654654', cpf: '111.111.111-11' },
                { nome: 'Eddy', rg: 'zcxzxc', cpf: '222.222.222-22' },
                { nome: 'Murilo', rg: '654654', cpf: '333.333.333-33' }
            ];
            const form = document.getElementById('cadastro-form');
            const student = exampleStudents[alunos.length % 3];
            form.nome.value = student.nome;
            form.rg.value = student.rg;
            form.cpf.value = student.cpf;
            form.email.value = `${student.nome.toLowerCase()}@escola.com`;
            form.telefone.value = '(47) 99999-9999';
            form.dataNascimento.value = '2005-01-01';
            form.localNascimento.value = 'Itapoá - SC';
            form.endereco.value = 'Rua das Flores, 123';
        });

        updateDashboard();
    </script>
</body>
</html>
