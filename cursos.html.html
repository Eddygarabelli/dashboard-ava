<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .page { display: none; }
        .page.active { display: block; }
        .modal, .modal-backdrop {
            display: none;
            transition: opacity 0.3s ease;
        }
        .modal.active, .modal-backdrop.active {
            display: flex;
            opacity: 1;
        }
        .modal-backdrop.active {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        .modal.active {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Cabeçalho -->
    <header class="bg-white shadow-md sticky top-0 z-30">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center">
                    <img id="logo-img" src="https://i.imgur.com/b6s5rvB.png" alt="Logo Escola da Barra" class="h-14 w-14 mr-4">
                    <span class="text-xl sm:text-2xl font-bold text-gray-800">Escola da Barra</span>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <a href="index.html" class="p-2 rounded-full text-gray-600 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div id="app-container" class="bg-white rounded-xl shadow-lg p-6 sm:p-8 w-full">
            <div id="course-years-page" class="page active"></div>
            <div id="year-subjects-page" class="page"></div>
            <div id="subject-students-page" class="page"></div>
        </div>
    </main>

    <!-- Modais e JS -->
    <div id="add-student-to-subject-modal" class="modal fixed inset-0 items-center justify-center z-50"></div>
    <div id="add-student-to-subject-backdrop" class="modal-backdrop"></div>
    <div id="edit-course-modal" class="modal fixed inset-0 items-center justify-center z-50"></div>
    <div id="edit-course-backdrop" class="modal-backdrop"></div>
    <div id="create-course-modal" class="modal fixed inset-0 items-center justify-center z-50"></div>
    <div id="create-course-backdrop" class="modal-backdrop"></div>

    <script>
        const cursosDisponiveis = JSON.parse(localStorage.getItem('cursosDisponiveis')) || {};
        let alunos = JSON.parse(localStorage.getItem('alunos')) || [];

        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function saveData() {
            localStorage.setItem('cursosDisponiveis', JSON.stringify(cursosDisponiveis));
            localStorage.setItem('alunos', JSON.stringify(alunos));
        }

        function renderCourseYears(courseName) {
            const course = cursosDisponiveis[courseName];
            if (!course) {
                console.error('Curso não encontrado:', courseName);
                window.location.href = 'index.html';
                return;
            }
            const container = document.getElementById('course-years-page');
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Anos do Ensino ${courseName}</h1>
                    <button class="edit-course-btn p-1 rounded-full hover:bg-gray-200" data-course-name="${courseName}">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                    </button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    ${Object.keys(course.anos).map(ano => `
                        <div class="bg-white p-6 rounded-lg shadow-md cursor-pointer hover:bg-blue-50 text-center" data-course="${courseName}" data-year="${ano}">
                            <h3 class="font-bold text-xl text-blue-700">${ano}</h3>
                        </div>
                    `).join('')}
                </div>
            `;
            navigateTo('course-years-page');
        }

        function renderYearSubjects(courseName, year) {
            const course = cursosDisponiveis[courseName];
            const container = document.getElementById('year-subjects-page');
            const disciplinasDoAno = course.anos[year].disciplinas;
            let content = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">${year} - ${courseName}</h1>
                    <button class="edit-course-btn p-1 rounded-full hover:bg-gray-200" data-course-name="${courseName}">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                    </button>
                </div>`;

            for (const area in disciplinasDoAno) {
                content += `<h2 class="text-2xl font-semibold text-gray-700 mt-6 mb-3 border-b-2 pb-2">${area}</h2>`;
                content += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                content += disciplinasDoAno[area].map(disciplina => `
                    <div class="bg-gray-100 p-4 rounded-lg shadow-sm cursor-pointer hover:bg-gray-200" data-course="${courseName}" data-year="${year}" data-subject="${disciplina.nome}">
                        <p class="font-semibold text-gray-800">${disciplina.nome}</p>
                    </div>
                `).join('');
                content += '</div>';
            }
            container.innerHTML = content;
            navigateTo('year-subjects-page');
        }
        
        function renderSubjectStudents(courseName, year, subject) {
            const subjectKey = `${courseName}-${year}-${subject}`;
            const matriculados = alunos.filter(a => a.matriculas && a.matriculas[subjectKey]);
            
            const container = document.getElementById('subject-students-page');
            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">${subject}</h1>
                        <p class="text-gray-500">${year} - ${courseName}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-semibold">Alunos Matriculados</p>
                        <p class="text-3xl font-bold text-blue-600">${matriculados.length}</p>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-6">
                    <button id="add-student-to-subject-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Adicionar Aluno
                    </button>
                    <button id="edit-subject-btn" class="p-2 rounded-full hover:bg-gray-200" data-course-name="${courseName}" data-year="${year}" data-subject="${subject}">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                    </button>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <ul class="divide-y divide-gray-200">
                        ${matriculados.length > 0 ? matriculados.map(aluno => `
                            <li class="py-3 flex justify-between items-center">
                                <div class="flex items-center">
                                    <img src="https://i.pravatar.cc/150?u=${aluno.id}" class="w-10 h-10 rounded-full mr-3">
                                    <div>
                                        <p class="font-semibold">${aluno.nome}</p>
                                        <p class="text-sm text-gray-500">Matrícula: ${aluno.matricula}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <button class="view-grades-btn p-2 rounded-full hover:bg-gray-200" data-aluno-id="${aluno.id}" data-subject-key="${subjectKey}">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                                    </button>
                                     <button class="edit-grades-btn p-2 rounded-full hover:bg-gray-200" data-aluno-id="${aluno.id}" data-subject-key="${subjectKey}">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                                    </button>
                                    <button class="download-individual-grades-btn p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200" data-aluno-id="${aluno.id}" data-subject-key="${subjectKey}">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    </button>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            navigateTo('subject-students-page');
            document.getElementById('add-student-to-subject-btn').dataset.subjectKey = subjectKey;
        }

        function openAddStudentToSubjectModal(subjectKey) {
            const modal = document.getElementById('add-student-to-subject-modal');
            const backdrop = document.getElementById('add-student-to-subject-backdrop');
            
            const matriculadosIds = alunos
                .filter(a => a.matriculas && a.matriculas[subjectKey])
                .map(a => a.id);
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                    <h2 class="text-xl font-bold mb-4">Adicionar Aluno à Disciplina</h2>
                    <ul class="max-h-80 overflow-y-auto divide-y divide-gray-200">
                        ${alunos.map(aluno => `
                            <li class="py-2 flex items-center justify-between">
                                <span>${aluno.nome}</span>
                                <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600" data-aluno-id="${aluno.id}" ${matriculadosIds.includes(aluno.id) ? 'checked' : ''}>
                            </li>
                        `).join('')}
                    </ul>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancel-add-student" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button id="confirm-add-student" class="px-4 py-2 bg-blue-600 text-white rounded-md">Salvar</button>
                    </div>
                </div>
            `;

            modal.classList.add('active');
            backdrop.classList.add('active');

            backdrop.onclick = () => closeAddStudentToSubjectModal(subjectKey);
            document.getElementById('cancel-add-student').onclick = () => closeAddStudentToSubjectModal(subjectKey);
            document.getElementById('confirm-add-student').onclick = () => {
                const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    const alunoId = cb.dataset.alunoId;
                    const aluno = alunos.find(a => a.id === alunoId);
                    
                    if (cb.checked) {
                         if (!aluno.matriculas) aluno.matriculas = {};
                        if (!aluno.matriculas[subjectKey]) {
                            aluno.matriculas[subjectKey] = {
                                notas: { atv1: 0, rec1: 0, atv2: 0, rec2: 0, final: 0, recFinal: 0 }
                            };
                        }
                    } else {
                        if (aluno.matriculas && aluno.matriculas[subjectKey]) {
                            delete aluno.matriculas[subjectKey];
                        }
                    }
                });
                saveData();
                const [courseName, year, subject] = subjectKey.split('-');
                renderSubjectStudents(courseName, year, subject);
                closeAddStudentToSubjectModal(subjectKey);
            };
        }

        function closeAddStudentToSubjectModal() {
            document.getElementById('add-student-to-subject-modal').classList.remove('active');
            document.getElementById('add-student-to-subject-backdrop').classList.remove('active');
        }
        
        function openEditGradesModal(alunoId, subjectKey) {
            const aluno = alunos.find(a => a.id === alunoId);
            const notas = aluno.matriculas[subjectKey].notas;
            const modal = document.getElementById('edit-grades-modal');
            const backdrop = document.getElementById('edit-grades-backdrop');

            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
                    <h2 class="text-xl font-bold mb-4">Editar Notas de ${aluno.nome}</h2>
                    <div class="grid grid-cols-2 gap-4">
                        ${Object.keys(notas).map(key => `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 uppercase">${key}</label>
                                <input type="number" id="grade-${key}" value="${notas[key]}" class="form-input mt-1" min="0" max="10" step="0.1">
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancel-edit-grades" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button id="save-edit-grades" class="px-4 py-2 bg-blue-600 text-white rounded-md">Salvar</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            backdrop.classList.add('active');

            backdrop.onclick = closeEditGradesModal;
            document.getElementById('cancel-edit-grades').onclick = closeEditGradesModal;
            document.getElementById('save-edit-grades').onclick = () => {
                Object.keys(notas).forEach(key => {
                    notas[key] = parseFloat(document.getElementById(`grade-${key}`).value) || 0;
                });
                saveData();
                closeEditGradesModal();
            };
        }

        function closeEditGradesModal() {
            document.getElementById('edit-grades-modal').classList.remove('active');
            document.getElementById('edit-grades-backdrop').classList.remove('active');
        }

        function openEditCourseModal(courseName) {
            const course = cursosDisponiveis[courseName];
            if (!course) return;

            const modal = document.getElementById('edit-course-modal');
            const backdrop = document.getElementById('edit-course-backdrop');
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Editar Curso: ${courseName}</h2>
                        <button id="delete-course-btn" class="p-2 rounded-full text-red-500 hover:bg-red-100 disabled:opacity-50" data-course-name="${courseName}">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-1 12H5L4 7m5 0V4a1 1 0 011-1h4a1 1 0 011 1v3M9 7h6"></path></svg>
                        </button>
                    </div>
                    <div id="course-editor-container" class="space-y-4 max-h-80 overflow-y-auto">
                        <input type="text" id="edit-course-name" class="form-input mb-4 font-bold text-xl" value="${courseName}">
                        <input type="text" id="edit-course-description" class="form-input mb-4" value="${course.description || ''}" placeholder="Descrição do Curso">
                        <div id="years-editor-container">
                            ${Object.keys(course.anos).map(anoName => `
                                <div class="year-editor border p-4 rounded-md bg-gray-100 mb-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <input type="text" class="year-name-input form-input font-semibold text-lg" value="${anoName}">
                                        <button class="remove-year-btn text-red-500 hover:text-red-700 p-2">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-1 12H5L4 7m5 0V4a1 1 0 011-1h4a1 1 0 011 1v3M9 7h6"></path></svg>
                                        </button>
                                    </div>
                                    <div class="disciplines-container space-y-2">
                                        ${Object.keys(course.anos[anoName].disciplinas).map(areaName => `
                                            <div class="discipline-area-editor p-2 rounded-md bg-white">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <input type="text" class="discipline-area-name form-input font-bold" value="${areaName}">
                                                    <button class="remove-area-btn text-red-500 hover:text-red-700 p-2" data-year-name="${anoName}" data-area-name="${areaName}">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                    </button>
                                                </div>
                                                <div class="discipline-inputs space-y-1 ml-4">
                                                    ${course.anos[anoName].disciplinas[areaName].map(disciplina => `
                                                        <div class="flex gap-2 items-center">
                                                            <input type="text" class="discipline-name-input form-input" value="${disciplina.nome}">
                                                            <input type="number" class="discipline-hours-input form-input w-20" value="${disciplina.cargaHoraria}">
                                                            <button class="remove-discipline-btn p-1 text-red-500 hover:text-red-700">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                                            </button>
                                                        </div>
                                                    `).join('')}
                                                    <button class="add-discipline-btn mt-2 w-full bg-gray-200 hover:bg-gray-300 rounded-md py-1 text-sm flex items-center justify-center gap-1">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                                        Adicionar Disciplina
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                        <button class="add-area-btn mt-4 w-full bg-gray-300 hover:bg-gray-400 rounded-md py-2 text-sm">Adicionar Área</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button id="add-new-year-btn" class="mt-4 w-full bg-gray-300 hover:bg-gray-400 rounded-md py-2 text-sm">Adicionar Ano</button>
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancel-edit-course" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button id="save-edit-course" class="px-4 py-2 bg-blue-600 text-white rounded-md">Salvar Mudanças</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            backdrop.classList.add('active');

            const deleteCourseBtn = document.getElementById('delete-course-btn');
            const hasNotes = alunos.some(aluno =>
                Object.keys(aluno.matriculas).some(key => key.startsWith(courseName))
            );
            deleteCourseBtn.disabled = hasNotes;

            backdrop.onclick = closeEditCourseModal;
            document.getElementById('cancel-edit-course').onclick = closeEditCourseModal;

            deleteCourseBtn.onclick = () => {
                if (confirm(`Tem certeza que deseja excluir o curso "${courseName}"? Esta ação é irreversível.`)) {
                    delete cursosDisponiveis[courseName];
                    saveData();
                    closeEditCourseModal();
                    window.location.href = 'index.html';
                }
            };
            
            document.getElementById('save-edit-course').onclick = () => {
                const newCourseName = document.getElementById('edit-course-name').value.trim();
                if (!newCourseName) { alert('O nome do curso não pode ser vazio.'); return; }
                
                const anos = {};
                document.querySelectorAll('#years-editor-container > .year-editor').forEach(yearEditor => {
                    const yearName = yearEditor.querySelector('.year-name-input').value.trim();
                    if (!yearName) return;
                    
                    const disciplines = {};
                    yearEditor.querySelectorAll('.discipline-area-editor').forEach(areaEditor => {
                        const areaName = areaEditor.querySelector('.discipline-area-name').value.trim();
                        if (!areaName) return;
                        
                        const areaDisciplines = [];
                        areaEditor.querySelectorAll('.discipline-inputs > div').forEach(disciplineInput => {
                            const nome = disciplineInput.querySelector('.discipline-name-input').value.trim();
                            const cargaHoraria = parseInt(disciplineInput.querySelector('.discipline-hours-input').value);
                            if (nome) areaDisciplines.push({ nome, cargaHoraria });
                        });
                        disciplines[areaName] = areaDisciplines;
                    });
                    anos[yearName] = { disciplines };
                });

                if (courseName !== newCourseName) {
                    delete cursosDisponiveis[courseName];
                }
                cursosDisponiveis[newCourseName] = {
                    description: document.getElementById('edit-course-description').value.trim(),
                    anos: anos
                };
                
                saveData();
                closeEditCourseModal();
                window.location.href = 'cursos.html?course=' + encodeURIComponent(newCourseName);
            };

            const yearsEditorContainer = document.getElementById('years-editor-container');
            document.getElementById('add-new-year-btn').onclick = () => {
                const newYearHtml = `
                    <div class="year-editor border p-4 rounded-md bg-gray-100 mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <input type="text" class="year-name-input form-input font-semibold text-lg" placeholder="Ex: 1º Ano">
                            <button class="remove-year-btn text-red-500 hover:text-red-700 p-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-1 12H5L4 7m5 0V4a1 1 0 011-1h4a1 1 0 011 1v3M9 7h6"></path></svg>
                            </button>
                        </div>
                        <div class="disciplines-container space-y-2">
                            <button class="add-area-btn mt-4 w-full bg-gray-300 hover:bg-gray-400 rounded-md py-2 text-sm">Adicionar Área</button>
                        </div>
                    </div>`;
                yearsEditorContainer.insertAdjacentHTML('beforeend', newYearHtml);
            };

            modal.addEventListener('click', (e) => {
                const removeYearBtn = e.target.closest('.remove-year-btn');
                if (removeYearBtn) {
                    removeYearBtn.closest('.year-editor').remove();
                    return;
                }
                
                const addAreaBtn = e.target.closest('.add-area-btn');
                if (addAreaBtn) {
                    const disciplinesContainer = addAreaBtn.closest('.disciplines-container');
                    const newAreaEditorHtml = `
                        <div class="discipline-area-editor p-2 rounded-md bg-white">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="text" class="discipline-area-name form-input font-bold" placeholder="Área (ex: Linguagens)">
                                <button class="remove-area-btn text-red-500 hover:text-red-700 p-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                            <div class="discipline-inputs space-y-1 ml-4">
                                <div class="flex gap-2 items-center">
                                    <input type="text" class="discipline-name-input form-input" placeholder="Nome da Disciplina">
                                    <input type="number" class="discipline-hours-input form-input w-20" placeholder="CH">
                                    <button class="remove-discipline-btn p-1 text-red-500 hover:text-red-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <button class="add-discipline-btn mt-2 w-full bg-gray-200 hover:bg-gray-300 rounded-md py-1 text-sm flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Adicionar Disciplina
                            </button>
                        </div>`;
                    disciplinesContainer.insertAdjacentHTML('afterbegin', newAreaEditorHtml);
                    return;
                }

                const removeAreaBtn = e.target.closest('.remove-area-btn');
                if (removeAreaBtn) {
                    removeAreaBtn.closest('.discipline-area-editor').remove();
                    return;
                }

                const addDisciplineBtn = e.target.closest('.add-discipline-btn');
                if (addDisciplineBtn) {
                    const disciplineInputsContainer = addDisciplineBtn.closest('.discipline-area-editor').querySelector('.discipline-inputs');
                    const newDisciplineInputHtml = `
                        <div class="flex gap-2 items-center">
                            <input type="text" class="discipline-name-input form-input" placeholder="Nome da Disciplina">
                            <input type="number" class="discipline-hours-input form-input w-20" placeholder="CH">
                            <button class="remove-discipline-btn p-1 text-red-500 hover:text-red-700">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </button>
                        </div>`;
                    disciplineInputsContainer.insertAdjacentHTML('beforeend', newDisciplineInputHtml);
                    return;
                }

                const removeDisciplineBtn = e.target.closest('.remove-discipline-btn');
                if (removeDisciplineBtn) {
                    removeDisciplineBtn.closest('.flex.gap-2.items-center').remove();
                }
            });
        }

        function closeCreateCourseModal() {
            document.getElementById('create-course-modal').classList.remove('active');
            document.getElementById('create-course-backdrop').classList.remove('active');
        }
        
        function openEditGradesModal(alunoId, subjectKey) {
            const aluno = alunos.find(a => a.id === alunoId);
            const notas = aluno.matriculas[subjectKey].notas;
            const modal = document.getElementById('edit-grades-modal');
            const backdrop = document.getElementById('edit-grades-backdrop');

            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
                    <h2 class="text-xl font-bold mb-4">Editar Notas de ${aluno.nome}</h2>
                    <div class="grid grid-cols-2 gap-4">
                        ${Object.keys(notas).map(key => `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 uppercase">${key}</label>
                                <input type="number" id="grade-${key}" value="${notas[key]}" class="form-input mt-1" min="0" max="10" step="0.1">
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancel-edit-grades" class="px-4 py-2 bg-gray-200 rounded-md">Cancelar</button>
                        <button id="save-edit-grades" class="px-4 py-2 bg-blue-600 text-white rounded-md">Salvar</button>
                    </div>
                </div>
            `;
            modal.classList.add('active');
            backdrop.classList.add('active');

            backdrop.onclick = closeEditGradesModal;
            document.getElementById('cancel-edit-grades').onclick = closeEditGradesModal;
            document.getElementById('save-edit-grades').onclick = () => {
                Object.keys(notas).forEach(key => {
                    notas[key] = parseFloat(document.getElementById(`grade-${key}`).value) || 0;
                });
                saveData();
                closeEditGradesModal();
            };
        }

        function closeEditGradesModal() {
            document.getElementById('edit-grades-modal').classList.remove('active');
            document.getElementById('edit-grades-backdrop').classList.remove('active');
        }

        function calcularMediaFinal(notas) {
            const nota1 = Math.max(notas.atv1, notas.rec1);
            const nota2 = Math.max(notas.atv2, notas.rec2);
            const notaFinal = Math.max(notas.final, notas.recFinal);
            return (nota1 + nota2 + notaFinal) / 3;
        }
        
        function generatePDF(alunosParaPDF, filename) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const logo = new Image();
            logo.src = 'https://i.imgur.com/b6s5rvB.png';
            logo.onload = function() {
                const logoData = this.src;
                
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text('Boletim Escolar', 105, 25, { align: 'center' });
                doc.addImage(logoData, 'PNG', 15, 15, 20, 20);

                let startY = 40;

                alunosParaPDF.forEach((aluno, index) => {
                    const alunoMatriculas = Object.values(aluno.matriculas);
                    
                    if (index > 0 && startY > 250) {
                        doc.addPage();
                        startY = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${aluno.nome}`, 15, startY);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Matrícula: ${aluno.matricula}`, 15, startY + 5);
                    
                    const head = [['Curso', 'Série', 'Disciplina', 'Média Final']];
                    const body = Object.entries(aluno.matriculas).map(([key, data]) => {
                        const [curso, ano, disciplina] = key.split('-');
                        const media = calcularMediaFinal(data.notas).toFixed(1);
                        return [curso, ano, disciplina, media];
                    });
                    
                    doc.autoTable({
                        startY: startY + 10,
                        head: head,
                        body: body,
                        theme: 'striped',
                        headStyles: { fillColor: [41, 128, 185], textColor: 255 },
                        didDrawPage: function(data) {
                            startY = data.cursor.y + 15;
                        }
                    });
                     startY = doc.lastAutoTable.finalY + 15;
                });

                doc.save(`${filename}.pdf`);
            };
            logo.onerror = function() {
                console.error("Erro ao carregar a imagem do logo.");
            };
        }

        document.addEventListener('click', (e) => {
            const courseYearCard = e.target.closest('[data-course][data-year]');
            if (courseYearCard) {
                renderYearSubjects(courseYearCard.dataset.course, courseYearCard.dataset.year);
            }
            
            const yearSubjectCard = e.target.closest('[data-course][data-year][data-subject]');
            if (yearSubjectCard) {
                renderSubjectStudents(yearSubjectCard.dataset.course, yearSubjectCard.dataset.year, yearSubjectCard.dataset.subject);
            }

            const addStudentBtn = e.target.closest('#add-student-to-subject-btn');
            if (addStudentBtn) {
                openAddStudentToSubjectModal(addStudentBtn.dataset.subjectKey);
            }

            const editGradesBtn = e.target.closest('.edit-grades-btn');
            if (editGradesBtn) {
                openEditGradesModal(editGradesBtn.dataset.alunoId, editGradesBtn.dataset.subjectKey);
            }
            
            const editCourseBtn = e.target.closest('.edit-course-btn');
            if (editCourseBtn) {
                openEditCourseModal(editCourseBtn.dataset.courseName);
            }

            const createCourseBtn = e.target.closest('#create-course-btn');
            if (createCourseBtn) {
                openCreateCourseModal();
            }
        });
        
        const urlParams = new URLSearchParams(window.location.search);
        const courseName = urlParams.get('course');
        if (courseName) {
            renderCourseYears(courseName);
        } else {
            document.getElementById('course-years-page').innerHTML = `
                <p class="text-center text-gray-500">Selecione um curso na página inicial para começar.</p>
            `;
        }
    </script>
</body>
</html>
