<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Gestão Escolar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
    .page { display: none; }
    .page.active { display: block; }
    .nav-button.active { background-color: #2563eb; color: white; box-shadow: 0 4px 6px rgba(37,99,235,0.3); }
    .nav-button { transition: all .2s ease-in-out; }
    .nav-button:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0,0,0,.1); }
    .form-input { width: 100%; padding: .75rem; border: 1px solid #d1d5db; border-radius: .375rem; }
    .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.3); }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <header class="bg-white shadow-md sticky top-0 z-30">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex items-center justify-between h-20">
        <div class="flex items-center">
          <img src="https://i.imgur.com/b6s5rvB.png" alt="Logo" class="h-14 w-14 mr-4">
          <span class="text-xl sm:text-2xl font-bold text-gray-800">Escola da Barra</span>
        </div>
        <div class="flex gap-2">
          <button class="nav-button px-4 py-2 rounded-full font-semibold text-gray-700 bg-gray-100" data-target="alunos-dashboard">Alunos</button>
          <button class="nav-button px-4 py-2 rounded-full font-semibold text-gray-700 bg-gray-100" data-target="cursos-dashboard">Cursos</button>
          <button class="nav-button px-4 py-2 rounded-full font-semibold text-gray-700 bg-gray-100" data-target="pedagogico-dashboard">Pedagógico</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 sm:p-6">
    <div id="dashboard-page" class="page active">
      <div class="flex justify-center flex-wrap gap-4 mb-8">
        <button class="nav-button active px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-100" data-target="alunos-dashboard">Alunos</button>
        <button class="nav-button px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-100" data-target="cursos-dashboard">Cursos</button>
        <button class="nav-button px-6 py-2 rounded-full font-semibold text-gray-700 bg-gray-100" data-target="pedagogico-dashboard">Pedagógico</button>
      </div>

      <!-- DASHBOARD ALUNOS -->
      <div id="alunos-dashboard" class="dashboard-content">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-blue-500 text-white rounded-xl p-6 shadow-md transform hover:scale-105 transition-transform cursor-pointer" id="card-alunos-matriculados">
            <h3 class="text-lg">Alunos Matriculados</h3>
            <p id="alunos-count" class="text-5xl font-extrabold mt-2">0</p>
          </div>
          <div class="bg-green-500 text-white rounded-xl p-6 shadow-md transform hover:scale-105 transition-transform cursor-pointer" id="card-novo-aluno">
            <h3 class="text-lg">Novo Aluno</h3>
            <p class="text-5xl font-extrabold mt-2">+</p>
          </div>
        </div>
      </div>

      <!-- DASHBOARD CURSOS (layout apenas, sem navegação forçada) -->
      <div id="cursos-dashboard" class="dashboard-content hidden">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-indigo-500 text-white rounded-xl p-6 shadow-md">
            <h3 class="text-lg">Ensino Fundamental</h3>
            <p class="text-2xl font-bold mt-2">6º ao 9º ano</p>
          </div>
          <div class="bg-purple-500 text-white rounded-xl p-6 shadow-md">
            <h3 class="text-lg">Ensino Médio</h3>
            <p class="text-2xl font-bold mt-2">1º ao 3º ano</p>
          </div>
        </div>
      </div>

      <!-- DASHBOARD PEDAGÓGICO (layout apenas) -->
      <div id="pedagogico-dashboard" class="dashboard-content hidden">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-teal-500 text-white rounded-xl p-6 shadow-md">
            <h3 class="text-lg">Boletim Geral</h3>
            <p class="text-2xl font-bold mt-2">Ver Notas</p>
          </div>
          <div class="bg-orange-500 text-white rounded-xl p-6 shadow-md">
            <h3 class="text-lg">Download</h3>
            <p class="text-2xl font-bold mt-2">Gerar Relatório</p>
          </div>
        </div>
      </div>
    </div>

    <!-- PÁGINA: CADASTRO -->
    <div id="cadastro-page" class="page">
      <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Cadastro de Aluno</h1>
      <form id="cadastro-form" class="space-y-4 max-w-lg mx-auto">
        <input type="text" id="nome" placeholder="Nome Completo" required class="form-input">
        <input type="text" id="rg" placeholder="RG" class="form-input">
        <input type="text" id="cpf" placeholder="CPF" class="form-input">
        <input type="email" id="email" placeholder="E-mail" class="form-input">
        <input type="tel" id="telefone" placeholder="Telefone" class="form-input">
        <input type="date" id="datanascimento" placeholder="Data de Nascimento" class="form-input">
        <input type="text" id="localnascimento" placeholder="Local de Nascimento (Cidade - UF)" class="form-input">
        <input type="text" id="endereco" placeholder="Endereço Completo" class="form-input">
        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition-colors shadow-sm">Cadastrar Aluno</button>
      </form>
    </div>

    <!-- PÁGINA: LISTA ALUNOS -->
    <div id="alunos-list-page" class="page"></div>
  </main>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    // Navegação simples entre seções do dashboard
    function showDashboardTab(targetId){
      document.querySelectorAll('.dashboard-content').forEach(el => el.classList.add('hidden'));
      document.getElementById(targetId)?.classList.remove('hidden');
      document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.nav-button[data-target="'+targetId+'"]').forEach(b => b.classList.add('active'));
    }

    function navigateTo(pageId){
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId)?.classList.add('active');
    }

    // Bind dos botões principais
    document.addEventListener('DOMContentLoaded', () => {
      // Tabs do dashboard
      document.querySelectorAll('.nav-button').forEach(btn => {
        btn.addEventListener('click', () => showDashboardTab(btn.dataset.target));
      });

      // Cards
      document.getElementById('card-novo-aluno')?.addEventListener('click', () => navigateTo('cadastro-page'));
      document.getElementById('card-alunos-matriculados')?.addEventListener('click', () => renderAlunosList());

      // Começa mostrando "Alunos" na aba
      showDashboardTab('alunos-dashboard');

      // Atualiza contagem
      updateAlunosCount();

      // Submit do cadastro
      document.getElementById('cadastro-form')?.addEventListener('submit', onSubmitCadastro);
    });

    async function updateAlunosCount(){
      const el = document.getElementById('alunos-count');
      try{
        const { count, error } = await supabase.from('alunos').select('*', { count:'exact', head:true });
        if (error) throw error;
        if (el) el.textContent = String(count ?? 0);
      }catch(e){
        console.error('Contagem alunos:', e);
        if (el) el.textContent = '0';
      }
    }

    function geraMatricula(){
      // ex.: MAT-278351 (baseado no timestamp)
      return 'MAT-' + (Date.now().toString().slice(-6));
    }

    async function onSubmitCadastro(e){
      e.preventDefault();
      const form = e.currentTarget;
      const payload = {
        matricula: geraMatricula(),
        nome: document.getElementById('nome')?.value?.trim() || '',
        rg: document.getElementById('rg')?.value?.trim() || '',
        cpf: document.getElementById('cpf')?.value?.trim() || '',
        email: document.getElementById('email')?.value?.trim() || '',
        telefone: document.getElementById('telefone')?.value?.trim() || '',
        datanascimento: document.getElementById('datanascimento')?.value || null,
        localnascimento: document.getElementById('localnascimento')?.value?.trim() || '',
        endereco: document.getElementById('endereco')?.value?.trim() || '',
        datacadastro: new Date().toISOString()
      };
      try{
        const { data, error } = await supabase.from('alunos').insert([payload]).select('*');
        if (error){
          console.error('Erro ao cadastrar aluno:', error);
          alert('Erro ao cadastrar aluno. Verifique os dados e tente novamente.');
          return;
        }
        alert('Aluno cadastrado com sucesso!');
        form.reset();
        updateAlunosCount();
        renderAlunosList(); // vai para a lista após cadastrar
      }catch(err){
        console.error(err);
        alert('Erro inesperado ao cadastrar.');
      }
    }

    async function renderAlunosList(){
      const container = document.getElementById('alunos-list-page');
      container.innerHTML = '<div class="text-center text-gray-500">Carregando...</div>';
      navigateTo('alunos-list-page');
      try{
        const { data, error } = await supabase
          .from('alunos')
          .select('id, nome, matricula, datacadastro')
          .order('datacadastro', { ascending: false });
        if (error) throw error;

        if (!data || data.length === 0){
          container.innerHTML = '<div class="text-center text-gray-500">Nenhum aluno cadastrado ainda.</div>';
          return;
        }
        container.innerHTML = `
          <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Alunos Matriculados</h1>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${data.map(a => `
              <div class="bg-white p-4 rounded-lg shadow-md">
                <div class="flex items-center">
                  <img src="https://i.pravatar.cc/150?u=${a.id}" alt="Foto" class="w-16 h-16 rounded-full mr-4">
                  <div>
                    <h3 class="font-bold text-lg text-gray-800">${a.nome ?? ''}</h3>
                    <p class="text-sm text-gray-500">Matrícula: ${a.matricula ?? '-'}</p>
                    <p class="text-sm text-gray-500">Cadastro: ${a.datacadastro ? new Date(a.datacadastro).toLocaleDateString() : '-'}</p>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>`;
      }catch(e){
        console.error('Erro listando alunos:', e);
        container.innerHTML = '<div class="text-center text-red-600">Erro ao carregar alunos.</div>';
      }
    }
  </script>
</body>
</html>
